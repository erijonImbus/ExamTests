name: Robot Framework Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 2 * * 1-5"

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      IMAGE: robotframework-docker-test
      VERSION: 1.0
      BROWSER: headlesschrome
      TAGS: ""
      EXCLUDE_TAGS: ""

    steps:
      # Checkout the repository to get the latest code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Docker
      - name: Set Up Docker
        run: |
          echo "Checking Docker installation..."
          docker version

      # Build Docker Image from Dockerfile
      - name: Build Docker Image
        run: |
          echo "Building Docker image from Dockerfile..."
          docker build -t ${{ env.IMAGE }}:${{ env.VERSION }} -f .github/workflows/Dockerfile .

      # Run the tests in dryrun mode using the built Docker image
      - name: Run Tests - Dryrun
        run: |
          echo "Running tests using image ${{ env.IMAGE }}:${{ env.VERSION }}..."
          docker run --rm -v ${PWD}:/app ${{ env.IMAGE }}:${{ env.VERSION }}
          docker run --rm -v ${PWD}:/app ${{ env.IMAGE }}:${{ env.VERSION }} bash -c '
          robot --dryrun --outputdir /app/output/dryrun /app
            '

      # Run the actual test cases using the built Docker image
      # - name: Run Test Cases
      #   run: |
      #     echo "Running tests using image ${{ env.IMAGE }}:${{ env.VERSION }}..."
      #     docker run --rm -v ${PWD}:/app ${{ env.IMAGE }}:${{ env.VERSION }} `
      #     powershell -Command "robot --outputdir /app/output/run -v BROWSER:${{ env.BROWSER }} --include ${{ env.TAGS }} --exclude ${{ env.EXCLUDE_TAGS }} /app"

      # Archive the Dryrun test logs
      - name: Archive Test Logs - Dryrun
        uses: actions/upload-artifact@v4
        with:
          name: dryrun-logs
          path: output/dryrun/

      # Archive the Run test logs
      - name: Archive Test Logs - Run
        uses: actions/upload-artifact@v4
        with:
          name: run-logs
          path: output/run/

      # Publish the HTML reports from the Run test logs
      - name: Publish HTML Reports
        uses: actions/upload-artifact@v4
        with:
          name: robot-test-reports
          path: output/run/report.html
